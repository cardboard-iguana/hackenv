#!/usr/bin/env bash

# FIXME: For some reason, direnv reloads it environment *twice* on
# rebuild (once when it's supposed to, and a second time for...
# reasons), even though nothing has changed. Pre-generating flake.lock
# does *not* fix this. Fortunately, this is mostly aesthetic; costly
# actions (such as setting up Python, Node, and Ruby) are *not*
# repeated.

export ENGAGEMENT_NAME_FOR_HUMANS="{{ENGAGEMENT_NAME_FOR_HUMANS}}"
export ENGAGEMENT_NAME="{{ENGAGEMENT_NAME}}"

echo "direnv: Loading reproducible environment for $ENGAGEMENT_NAME_FOR_HUMANS"

# Initial build can take a while, so disable the associated warning
#
# Unfortunately, this only works *after* the first run
#
export DIRENV_WARN_TIMEOUT=0

# Init the environment
#
use flake

# Python setup
#
#
# Inspired by:
#
#   https://github.com/direnv/direnv/issues/1194#issuecomment-1849002795
#
# Note that we need to call `layout python` once to set VIRTUAL_ENV,
# even though we may wipe-and-rebuild it later. The net result is that
# $VIRTUAL_ENV/bin will sometimes be present twice in the PATH.
#
layout python
watch_file requirements.txt

export PIP_NO_BINARY=":all:"

if [[ ! -f "$VIRTUAL_ENV"/.sentinal ]] && [[ -f requirements.lock ]]; then
    echo "direnv: Installing Python packages from requirements.lock"

    if [[ -d "$VIRTUAL_ENV" ]]; then
        rm -rf "$VIRTUAL_ENV"
        layout python
    fi

    pip install -r requirements.lock

    touch "$VIRTUAL_ENV"/.sentinal
elif [[ ! -f "$VIRTUAL_ENV"/.sentinal ]] || [[ requirements.txt -nt "$VIRTUAL_ENV"/.sentinal ]]; then
    echo "direnv: Installing Python packages from requirements.txt"

    if [[ -d "$VIRTUAL_ENV" ]]; then
        rm -rf "$VIRTUAL_ENV"
        layout python
    fi

    pip install --upgrade pip
    pip install -r requirements.txt

    pip freeze --all --local >requirements.lock
    touch "$VIRTUAL_ENV"/.sentinal
fi

if [[ ! -e "$VIRTUAL_ENV"/.solc-select ]]; then
    echo "direnv: Setting up solc-select cache"
    if [[ ! -d "$PWD"/appdata/solc-select ]]; then
        mkdir -p "$PWD"/appdata/solc-select
    fi
    ln -nsf "$PWD"/appdata/solc-select "$VIRTUAL_ENV"/.solc-select
fi

# It's not uncommon to proxy Python apps through Burp Suite or another
# tool, which can result in warnings about untrusted SSL certificates.
# These are annoying, so we disable them. (DON'T do this GLOBALLY
# though! Warnings about unverified SSL certificates exist for a
# reason!)
#
export PYTHONWARNINGS="${PYTHONWARNINGS:+$PYTHONWARNINGS,}ignore:Unverified HTTPS request"

# Node setup
#
layout node
watch_file package.json

if [[ ! -f node_modules/.sentinal ]] && [[ -f pnpm-lock.yaml ]]; then
    echo "direnv: Installing Node packages from pnpm-lock.yaml"

    if [[ -d node_modules ]]; then
        rm -rf node_modules
    fi

    pnpm install

    touch node_modules/.sentinal
elif [[ ! -f node_modules/.sentinal ]] || [[ package.json -nt pnpm-lock.yaml ]]; then
    echo "direnv: Installing Node packages from package.json"

    if [[ -d node_modules ]]; then
        rm -rf node_modules
    fi
    if [[ -f pnpm-lock.yaml ]]; then
        rm pnpm-lock.yaml
    fi

    pnpm install

    touch node_modules/.sentinal
fi

# Ruby setup
#
layout ruby
watch_file Gemfile

if [[ ! -f "$GEM_HOME"/.sentinal ]] && [[ -f Gemfile.lock ]]; then
    echo "direnv: Installing Ruby gems from Gemfile.lock"

    if [[ -d "$GEM_HOME" ]]; then
        rm -rf "$GEM_HOME"
        layout ruby
    fi
    find "$PWD"/.direnv/bin -type f -exec grep -l "This file was generated by Bundler" "{}" \; | while read -r BUNDLER_BIN; do
        rm -f "$BUNDLER_BIN"
    done

    bundle install 2>/dev/null

    touch "$GEM_HOME"/.sentinal
elif [[ ! -f "$GEM_HOME"/.sentinal ]] || [[ Gemfile -nt Gemfile.lock ]]; then
    echo "direnv: Installing Ruby gems from Gemfile"

    if [[ -d "$GEM_HOME" ]]; then
        rm -rf "$GEM_HOME"
        layout ruby
    fi
    if [[ -f Gemfile.lock ]]; then
        rm Gemfile.lock
    fi
    find "$PWD"/.direnv/bin -type f -exec grep -l "This file was generated by Bundler" "{}" \; | while read -r BUNDLER_BIN; do
        rm -f "$BUNDLER_BIN"
    done

    bundle install 2>/dev/null

    touch "$GEM_HOME"/.sentinal
fi

# Cache macOS applications
#
if [[ "$(uname -s)" == "Darwin" ]]; then
    if [[ -d "/Applications/Burp Suite Professional.app" ]]; then
        BURP_SUITE_APP="/Applications/Burp Suite Professional.app"
    elif [[ -d "$HOME/Applications/Burp Suite Professional.app" ]]; then
        BURP_SUITE_APP="$HOME/Applications/Burp Suite Professional.app"
    elif [[ -d "/Applications/Burp Suite Community Edition.app" ]]; then
        BURP_SUITE_APP="/Applications/Burp Suite Community Edition.app"
    elif [[ -d "$HOME/Applications/Burp Suite Community Edition.app" ]]; then
        BURP_SUITE_APP="$HOME/Applications/Burp Suite Community Edition.app"
    else
        BURP_SUITE_APP="DNE"
        echo "WARNING: Burp Suite not found!"
    fi

    if [[ -d "/Applications/Chromium.app" ]]; then
        CHROMIUM_APP="/Applications/Chromium.app"
    elif [[ -d "$HOME/Applications/Chromium.app" ]]; then
        CHROMIUM_APP="$HOME/Applications/Chromium.app"
    elif [[ -d "/Applications/Chromium.app" ]]; then
        CHROMIUM_APP="/Applications/Chromium.app"
    elif [[ -d "$HOME/Applications/Chromium.app" ]]; then
        CHROMIUM_APP="$HOME/Applications/Chromium.app"
    else
        CHROMIUM_APP="DNE"
        echo "WARNING: Chromium not found!"
    fi

    if [[ "$BURP_SUITE_APP" != "DNE" ]] || [[ "$CHROMIUM_APP" != "DNE" ]]; then
        if [[ ! -d "$PWD"/appdata/macOS/Applications ]]; then
            mkdir -p "$PWD"/appdata/macOS/Applications
        fi

        if [[ "$BURP_SUITE_APP" != "DNE" ]]; then
            BURP_SUITE_SYSTEM_MD5SUM="$(cat "$BURP_SUITE_APP"/Contents/Info.plist | md5sum)"
        else
            BURP_SUITE_SYSTEM_MD5SUM="DNE"
        fi
        if [[ -f "$PWD"/appdata/macOS/Applications/BurpSuite.app/Contents/Info.plist ]]; then
            BURP_SUITE_LOCAL_MD5SUM="$(cat "$PWD"/appdata/macOS/Applications/BurpSuite.app/Contents/Info.plist | md5sum)"
        else
            BURP_SUITE_LOCAL_MD5SUM="DNE"
        fi
        if [[ "$BURP_SUITE_LOCAL_MD5SUM" != "$BURP_SUITE_SYSTEM_MD5SUM" ]]; then
            echo "direnv: Caching Burp Suite application data"
            rsync --archive --delete "$BURP_SUITE_APP"/ "$PWD"/appdata/macOS/Applications/BurpSuite.app/
        fi

        if [[ "$CHROMIUM_APP" != "DNE" ]]; then
            CHROMIUM_SYSTEM_MD5SUM="$(cat "$CHROMIUM_APP"/Contents/Info.plist | md5sum)"
        else
            CHROMIUM_SYSTEM_MD5SUM="DNE"
        fi
        if [[ -f "$PWD"/appdata/macOS/Applications/Chromium.app/Contents/Info.plist ]]; then
            CHROMIUM_LOCAL_MD5SUM="$(cat "$PWD"/appdata/macOS/Applications/Chromium.app/Contents/Info.plist | md5sum)"
        else
            CHROMIUM_LOCAL_MD5SUM="DNE"
        fi
        if [[ "$CHROMIUM_LOCAL_MD5SUM" != "$CHROMIUM_SYSTEM_MD5SUM" ]]; then
            echo "direnv: Caching Chromium application data"
            rsync --archive --delete "$CHROMIUM_APP"/ "$PWD"/appdata/macOS/Applications/Chromium.app/
        fi
    fi
fi

# Burp Suite setup
#
if [[ ! -d "$PWD"/appdata/BurpSuite ]]; then
    mkdir -p "$PWD"/appdata/BurpSuite
fi
if [[ $(find "$PWD"/appdata/BurpSuite -mindepth 1 -maxdepth 1 -type f -iname "jython-standalone-*.jar" | wc -l) -eq 0 ]]; then
    echo "direnv: Downloading Jython"
    JYTHON_VERSION="$(curl -sL https://api.github.com/repos/jython/jython/tags | grep '"name": "v[0-9][0-9.]*"' | sed 's/.*"v\(.*\)".*/\1/' | sort -Vr | head -1)"
    (
        cd "$PWD"/appdata/BurpSuite || exit 1
        curl -#LO "https://repo1.maven.org/maven2/org/python/jython-standalone/${JYTHON_VERSION}/jython-standalone-${JYTHON_VERSION}.jar"
    )
fi
if [[ $(find "$PWD"/appdata/BurpSuite -mindepth 1 -maxdepth 1 -type f -iname "jruby-complete-*.jar" | wc -l) -eq 0 ]]; then
    echo "direnv: Downloading JRuby"
    JRUBY_VERSION="$(curl -sL https://api.github.com/repos/jruby/jruby/tags | grep '"name": "[0-9][0-9.]*"' | sed 's/.*"\(.*\)".*/\1/' | sort -Vr | head -1)"
    (
        cd "$PWD"/appdata/BurpSuite || exit 1
        curl -#LO "https://repo1.maven.org/maven2/org/jruby/jruby-complete/${JRUBY_VERSION}/jruby-complete-${JRUBY_VERSION}.jar"
    )
fi
if [[ ! -f "$PWD"/appdata/BurpSuite/UserConfigCommunity.json ]]; then
    echo "direnv: Configuring Burp Suite"
    JYTHON_PATH="$(find "$PWD"/appdata/BurpSuite -mindepth 1 -maxdepth 1 -type f -iname "jython-standalone-*.jar" | sort -r | head -1)"
    JRUBY_PATH="$(find "$PWD"/appdata/BurpSuite -mindepth 1 -maxdepth 1 -type f -iname "jruby-complete-*.jar" | sort -r | head -1)"
    cat "$PWD"/templates/BurpSuite/UserConfig.json | sed "s#{{JYTHON_PATH}}#$JYTHON_PATH#;s#{{JRUBY_PATH}}#$JRUBY_PATH#" >"$PWD"/appdata/BurpSuite/UserConfigCommunity.json
fi

# Metasploit setup
#
# Metasploit configuration directory must already exist, or else
# MSF_CFGROOT_CONFIG will be silently ignored
#
# Note that msfdb init cannot be run here, as it will cause direnv to
# hang
#
if [[ ! -d "$PWD"/appdata/metasploit ]]; then
    echo "direnv: Creating Metasploit configuration directory"
    mkdir -p "$PWD"/appdata/metasploit
fi

# Nikto setup
#
# We can easily determine the (unwrapped) Nikto executable path here
# because ./scripts hasn't yet been added to the PATH
#
if [[ ! -f "$PWD"/appdata/nikto.conf ]]; then
    echo "direnv: Creating default Nikto configuration"
    cp "$(dirname "$(dirname "$(which nikto)")")"/etc/nikto.conf "$PWD"/appdata/nikto.conf
fi

# ProxyChains-NG setup
#
if [[ ! -f "$PWD"/appdata/proxychains.conf ]]; then
    echo "direnv: Creating default ProxyChains configuration"
    cp "$(dirname "$(dirname "$(which proxychains4)")")"/etc/proxychains.conf "$PWD"/appdata/proxychains.conf
fi

# Wireshark setup
#
# Wireshark configuration directory must already exist, or else startup
# will be aborted
#
if [[ ! -d "$PWD"/appdata/wireshark ]]; then
    echo "direnv: Creating Wireshark configuration directory"
    mkdir -p "$PWD"/appdata/wireshark
fi

# Create artifacts directory
#
if [[ ! -d "$PWD"/artifacts ]]; then
    echo "direnv: Creating artifacts directory"
    mkdir -p "$PWD"/artifacts
fi

# Create wordlists directory
#
if [[ -n "$WORDLISTS" ]]; then
    mkdir -p "$PWD"/wordlists

    # https://stackoverflow.com/a/29949759
    IFS=: read -r -d '' -a WORDLISTS_ARRAY < <(printf '%s:\0' "$WORDLISTS")
    for WORDLIST in "${WORDLISTS_ARRAY[@]}"; do
        WORDLIST_NAME="$(basename "$WORDLIST")"
        echo "direnv: Building $WORDLIST_NAME wordlist"
        ln -nsf "$WORDLIST" "$PWD"/wordlists/"$WORDLIST_NAME"
    done
fi

# Add ./scripts to PATH
#
echo "direnv: Adding custom scripts and wrappers to the shell PATH"
PATH_add scripts

#### Application configuration #########################################

echo "direnv: Loading additional app configurations into the environment"

# less
#
export LESSHISTFILE="$PWD"/appdata/lesshst

# Shodan
#
export PYTHONWARNINGS="${PYTHONWARNINGS:+$PYTHONWARNINGS,}ignore:pkg_resources is deprecated"

# Android tools
#
export ANDROID_USER_HOME="$PWD"/appdata/android

# Asciinema
#
export ASCIINEMA_CONFIG_HOME="$PWD"/appdata/asciinema/config
export ASCIINEMA_STATE_HOME="$PWD"/appdata/asciinema/state

# Goose
#
export GOOSE_PATH_ROOT="$PWD"/appdata/goose
export CONTEXT_FILE_NAMES='["ENGAGEMENT.md", "AGENT.md", ".goosehints", "CLAUDE.md", ".cursorrules", "global_rules.md"]'

# John the Ripper
#
export JOHN="$PWD"/appdata/john

# Metsaploit
#
export MSF_CFGROOT_CONFIG="$PWD"/appdata/metasploit
export RUBYOPT="-W0"

# NetExec
#
export NXC_PATH="$PWD"/appdata/netexec

# ProxyChains-NG
#
export PROXYCHAINS_CONF_FILE="$PWD"/appdata/proxychains.conf

# SQLite
#
export SQLITE_HISTORY="$PWD"/appdata/sqlite_history
