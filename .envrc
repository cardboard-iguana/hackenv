# FIXME: For some reason, direnv reloads it environment multiple times
# after initialization, even though nothing has changed. Pre-generating
# flake.lock does *not* fix this. Fortunately, this is mostly aesthetic;
# costly actions (such as setting up Python, Node, and Ruby) are *not*
# repeated.

export ENGAGEMENT_NAME_FOR_HUMANS="{{ENGAGEMENT_NAME_FOR_HUMANS}}"
export ENGAGEMENT_NAME="{{ENGAGEMENT_NAME}}"

# Initial build can take a while, so disable the associated warning
#
# Unfortunately, this only works *after* the first run
#
export DIRENV_WARN_TIMEOUT=0

# Init the environment
#
use flake

# Python setup
#
#
# Inspired by:
#
#   https://github.com/direnv/direnv/issues/1194#issuecomment-1849002795
#
# Note that we need to call `layout python` once to set VIRTUAL_ENV,
# even though we may wipe-and-rebuild it later. The net result is that
# $VIRTUAL_ENV/bin will sometimes be present twice in the PATH.
#
layout python
watch_file .default-python-packages
watch_file requirements.txt

export PIP_NO_BINARY=":all:"

DEFAULT_PYTHON_PACKAGES="$(sed '/^[^0-9A-Za-z]/d;s/ .*//' .default-python-packages | xargs)"

if [[ ! -f requirements.txt ]] || [[ .default-python-packages -nt requirements.txt ]]; then
    if [[ -n "$DEFAULT_PYTHON_PACKAGES" ]]; then
        echo "Installing Python packages from .default-python-packages"

        if [[ -n "$VIRTUAL_ENV" ]] && [[ -d "$VIRTUAL_ENV" ]]; then
            rm -rf "$VIRTUAL_ENV"
            layout python
        fi
        if [[ -f requirements.txt ]]; then
            rm requirements.txt
        fi

        # shellcheck disable=SC2086
        pip install --upgrade pip $DEFAULT_PYTHON_PACKAGES
        pip freeze --all >requirements.txt
        touch "$VIRTUAL_ENV"/.sentinal
    fi
elif [[ -f requirements.txt ]] && [[ ! -f "$VIRTUAL_ENV"/.sentinal ]]; then
    echo "Installing Python packages from requirements.txt"

    if [[ -n "$VIRTUAL_ENV" ]] && [[ -d "$VIRTUAL_ENV" ]]; then
        rm -rf "$VIRTUAL_ENV"
        layout python
    fi

    pip install -r requirements.txt
    touch "$VIRTUAL_ENV"/.sentinal
fi

if [[ ! -e "$VIRTUAL_ENV"/.solc-select ]]; then
    echo "Setting up solc-select cache"
    ln -s "$PWD"/appdata/solc-select "$VIRTUAL_ENV"/.solc-select
fi

# It's not uncommon to proxy Python apps through Burp Suite or another
# tool, which can result in warnings about untrusted SSL certificates.
# These are annoying, so we disable them. (DON'T do this GLOBALLY
# though! Warnings about unverified SSL certificates exist for a
# reason!)
#
export PYTHONWARNINGS="${PYTHONWARNINGS:+$PYTHONWARNINGS,}ignore:Unverified HTTPS request"

# Node setup
#
layout node
watch_file .default-npm-packages
watch_file package.json

DEFAULT_NODE_PACKAGES="$(sed '/^[^0-9A-Za-z]/d;s/ .*//' .default-npm-packages | xargs)"

if [[ ! -f package.json ]] || [[ .default-npm-packages -nt package.json ]]; then
    if [[ -n "$DEFAULT_NODE_PACKAGES" ]]; then
        echo "Installing Node packages from .default-npm-packages"

        if [[ -d node_modules ]]; then
            rm -rf node_modules
        fi
        if [[ -f package.json ]]; then
            rm package.json
        fi
        if [[ -f pnpm-lock.yaml ]]; then
            rm pnpm-lock.yaml
        fi

        # shellcheck disable=SC2086
        pnpm install $DEFAULT_NODE_PACKAGES
        touch node_modules/.sentinal
    fi
elif [[ -f package.json ]] && [[ ! -f node_modules/.sentinal ]]; then
    echo "Installing Node packages from package.json"

    if [[ -d node_modules ]]; then
        rm -rf node_modules
    fi

    pnpm install
    touch node_modules/.sentinal
fi

# Ruby setup
#
layout ruby
watch_file .default-gems
watch_file Gemfile

DEFAULT_RUBY_PACKAGES="$(sed '/^[^0-9A-Za-z]/d;s/ .*//' .default-gems | xargs)"

# Shodan configuration
#
export PYTHONWARNINGS="${PYTHONWARNINGS:+$PYTHONWARNINGS,}ignore:pkg_resources is deprecated"

# Goose configuration
#
GOOSE_PATH_ROOT="$(dirname "$DIRENV_FILE")/appdata/goose"
export GOOSE_PATH_ROOT

export CONTEXT_FILE_NAMES='["ENGAGEMENT.md", "AGENT.md", ".goosehints", "CLAUDE.md", ".cursorrules", "global_rules.md"]'

#### Add additional engagement-specifc environment below ###############
