# FIXME: For some reason, direnv reloads it environment *twice* on
# rebuild (once when it's supposed to, and a second time for...
# reasons), even though nothing has changed. Pre-generating flake.lock
# does *not* fix this. Fortunately, this is mostly aesthetic; costly
# actions (such as setting up Python, Node, and Ruby) are *not*
# repeated.

export ENGAGEMENT_NAME_FOR_HUMANS="{{ENGAGEMENT_NAME_FOR_HUMANS}}"
export ENGAGEMENT_NAME="{{ENGAGEMENT_NAME}}"

echo "direnv: Loading reproducible environment for $ENGAGEMENT_NAME_FOR_HUMANS"

# Initial build can take a while, so disable the associated warning
#
# Unfortunately, this only works *after* the first run
#
export DIRENV_WARN_TIMEOUT=0

# Init the environment
#
use flake

# Python setup
#
#
# Inspired by:
#
#   https://github.com/direnv/direnv/issues/1194#issuecomment-1849002795
#
# Note that we need to call `layout python` once to set VIRTUAL_ENV,
# even though we may wipe-and-rebuild it later. The net result is that
# $VIRTUAL_ENV/bin will sometimes be present twice in the PATH.
#
layout python
watch_file requirements.txt

export PIP_NO_BINARY=":all:"

if [[ ! -f "$VIRTUAL_ENV"/.sentinal ]] && [[ -f requirements.lock ]]; then
    echo "direnv: Installing Python packages from requirements.lock"

    if [[ -d "$VIRTUAL_ENV" ]]; then
        rm -rf "$VIRTUAL_ENV"
        layout python
    fi

    pip install -r requirements.lock

    touch "$VIRTUAL_ENV"/.sentinal
elif [[ ! -f "$VIRTUAL_ENV"/.sentinal ]] || [[ requirements.txt -nt "$VIRTUAL_ENV"/.sentinal ]]; then
    echo "direnv: Installing Python packages from requirements.txt"

    if [[ -d "$VIRTUAL_ENV" ]]; then
        rm -rf "$VIRTUAL_ENV"
        layout python
    fi

    pip install --upgrade pip
    pip install -r requirements.txt

    pip freeze --all --local >requirements.lock
    touch "$VIRTUAL_ENV"/.sentinal
fi

if [[ ! -e "$VIRTUAL_ENV"/.solc-select ]]; then
    echo "direnv: Setting up solc-select cache"
    if [[ ! -d "$PWD"/appdata/solc-select ]]; then
        mkdir -p "$PWD"/appdata/solc-select
    fi
    ln -nsf "$PWD"/appdata/solc-select "$VIRTUAL_ENV"/.solc-select
fi

# It's not uncommon to proxy Python apps through Burp Suite or another
# tool, which can result in warnings about untrusted SSL certificates.
# These are annoying, so we disable them. (DON'T do this GLOBALLY
# though! Warnings about unverified SSL certificates exist for a
# reason!)
#
export PYTHONWARNINGS="${PYTHONWARNINGS:+$PYTHONWARNINGS,}ignore:Unverified HTTPS request"

# Node setup
#
layout node
watch_file package.json

if [[ ! -f node_modules/.sentinal ]] && [[ -f pnpm-lock.yaml ]]; then
    echo "direnv: Installing Node packages from pnpm-lock.yaml"

    if [[ -d node_modules ]]; then
        rm -rf node_modules
    fi

    pnpm install

    touch node_modules/.sentinal
elif [[ ! -f node_modules/.sentinal ]] || [[ package.json -nt pnpm-lock.yaml ]]; then
    echo "direnv: Installing Node packages from package.json"

    if [[ -d node_modules ]]; then
        rm -rf node_modules
    fi
    if [[ -f pnpm-lock.yaml ]]; then
        rm pnpm-lock.yaml
    fi

    pnpm install

    touch node_modules/.sentinal
fi

# Ruby setup
#
layout ruby
watch_file Gemfile

if [[ ! -f "$GEM_HOME"/.sentinal ]] && [[ -f Gemfile.lock ]]; then
    echo "direnv: Installing Ruby gems from Gemfile.lock"

    if [[ -d "$GEM_HOME" ]]; then
        rm -rf "$GEM_HOME"
        layout ruby
    fi
    find "$PWD"/.direnv/bin -type f -exec grep -l "This file was generated by Bundler" "{}" \; | while read -r BUNDLER_BIN; do
        rm -f "$BUNDLER_BIN"
    done

    bundle install 2>/dev/null

    touch "$GEM_HOME"/.sentinal
elif [[ ! -f "$GEM_HOME"/.sentinal ]] || [[ Gemfile -nt Gemfile.lock ]]; then
    echo "direnv: Installing Ruby gems from Gemfile"

    if [[ -d "$GEM_HOME" ]]; then
        rm -rf "$GEM_HOME"
        layout ruby
    fi
    if [[ -f Gemfile.lock ]]; then
        rm Gemfile.lock
    fi
    find "$PWD"/.direnv/bin -type f -exec grep -l "This file was generated by Bundler" "{}" \; | while read -r BUNDLER_BIN; do
        rm -f "$BUNDLER_BIN"
    done

    bundle install 2>/dev/null

    touch "$GEM_HOME"/.sentinal
fi

# Burp Suite setup
#
if [[ "$(uname -s)" == "Darwin" ]]; then
    if [[ -d "/Applications/Burp Suite Professional.app" ]]; then
        BURP_SUITE_APP="/Applications/Burp Suite Professional.app"
    elif [[ -d "$HOME/Applications/Burp Suite Professional.app" ]]; then
        BURP_SUITE_APP="$HOME/Applications/Burp Suite Professional.app"
    elif [[ -d "/Applications/Burp Suite Community Edition.app" ]]; then
        BURP_SUITE_APP="/Applications/Burp Suite Community Edition.app"
    elif [[ -d "$HOME/Applications/Burp Suite Community Edition.app" ]]; then
        BURP_SUITE_APP="$HOME/Applications/Burp Suite Community Edition.app"
    else
        BURP_SUITE_APP="DNE"
        echo "WARNING: Burp Suite not found!"
    fi

    if [[ "$BURP_SUITE_APP" != "DNE" ]]; then
        if [[ ! -d "$PWD"/appdata/macOS/Applications ]]; then
            mkdir -p "$PWD"/appdata/macOS/Applications
        fi

        if [[ "$BURP_SUITE_APP" != "DNE" ]]; then
            BURP_SUITE_SYSTEM_MD5SUM="$(cat "$BURP_SUITE_APP"/Contents/Info.plist | md5sum)"
        else
            BURP_SUITE_SYSTEM_MD5SUM="DNE"
        fi
        if [[ -f "$PWD"/appdata/macOS/Applications/BurpSuite.app/Contents/Info.plist ]]; then
            BURP_SUITE_LOCAL_MD5SUM="$(cat "$PWD"/appdata/macOS/Applications/BurpSuite.app/Contents/Info.plist | md5sum)"
        else
            BURP_SUITE_LOCAL_MD5SUM="DNE"
        fi
        if [[ "$BURP_SUITE_LOCAL_MD5SUM" != "$BURP_SUITE_SYSTEM_MD5SUM" ]]; then
            echo "direnv: Caching Burp Suite application data"
            rsync --archive --delete "$BURP_SUITE_APP"/ "$PWD"/appdata/macOS/Applications/BurpSuite.app/
        fi
    fi
fi
if [[ ! -d "$PWD"/appdata/BurpSuite ]]; then
    mkdir -p "$PWD"/appdata/BurpSuite
fi
if [[ $(find "$PWD"/appdata/BurpSuite -mindepth 1 -maxdepth 1 -type f -iname "jython-standalone-*.jar" | wc -l) -eq 0 ]]; then
    echo "direnv: Downloading Jython"
    JYTHON_VERSION="$(curl -sL https://api.github.com/repos/jython/jython/tags | grep '"name": "v[0-9][0-9.]*"' | sed 's/.*"v\(.*\)".*/\1/' | sort -Vr | head -1)"
    (
        cd "$PWD"/appdata/BurpSuite || exit 1
        curl -#LO "https://repo1.maven.org/maven2/org/python/jython-standalone/${JYTHON_VERSION}/jython-standalone-${JYTHON_VERSION}.jar"
    )
fi
if [[ $(find "$PWD"/appdata/BurpSuite -mindepth 1 -maxdepth 1 -type f -iname "jruby-complete-*.jar" | wc -l) -eq 0 ]]; then
    echo "direnv: Downloading JRuby"
    JRUBY_VERSION="$(curl -sL https://api.github.com/repos/jruby/jruby/tags | grep '"name": "[0-9][0-9.]*"' | sed 's/.*"\(.*\)".*/\1/' | sort -Vr | head -1)"
    (
        cd "$PWD"/appdata/BurpSuite || exit 1
        curl -#LO "https://repo1.maven.org/maven2/org/jruby/jruby-complete/${JRUBY_VERSION}/jruby-complete-${JRUBY_VERSION}.jar"
    )
fi
if [[ ! -f "$PWD"/appdata/BurpSuite/UserConfigCommunity.json ]]; then
    echo "direnv: Configuring Burp Suite"
    JYTHON_PATH="$(find "$PWD"/appdata/BurpSuite -mindepth 1 -maxdepth 1 -type f -iname "jython-standalone-*.jar" | sort -r | head -1)"
    JRUBY_PATH="$(find "$PWD"/appdata/BurpSuite -mindepth 1 -maxdepth 1 -type f -iname "jruby-complete-*.jar" | sort -r | head -1)"
    cat "$PWD"/templates/BurpSuite/UserConfig.json | sed "s#{{JYTHON_PATH}}#$JYTHON_PATH#;s#{{JRUBY_PATH}}#$JRUBY_PATH#" >"$PWD"/appdata/BurpSuite/UserConfigCommunity.json
fi

# Add ./scripts to PATH
#
PATH_add scripts

# Create artifacts directory
#
mkdir -p "$PWD"/artifacts

#### Application configuration #########################################

# less
#
export LESSHISTFILE="$PWD"/appdata/lesshst

# Shodan
#
export PYTHONWARNINGS="${PYTHONWARNINGS:+$PYTHONWARNINGS,}ignore:pkg_resources is deprecated"

# Android tools
#
export ANDROID_USER_HOME="$PWD"/appdata/android

# Goose
#
export GOOSE_PATH_ROOT="$PWD"/appdata/goose
export CONTEXT_FILE_NAMES='["ENGAGEMENT.md", "AGENT.md", ".goosehints", "CLAUDE.md", ".cursorrules", "global_rules.md"]'

# John the Ripper
#
export JOHN="$PWD"/appdata/john

# SQLite
#
export SQLITE_HISTORY="$PWD"/appdata/sqlite_history
