# FIXME: For some reason, direnv reloads it environment on the first
# prompt after initialization, even though nothing has changed.
# Pre-generating flake.lock does *not* fix this. Fortunately, this is
# mostly aesthetic; costly actions (such as setting up Python, Node, and
# Ruby) are *not* repeated.

export ENGAGEMENT_NAME_FOR_HUMANS="{{ENGAGEMENT_NAME_FOR_HUMANS}}"
export ENGAGEMENT_NAME="{{ENGAGEMENT_NAME}}"

echo "direnv: Loading reproducible environment for $ENGAGEMENT_NAME_FOR_HUMANS"

# Initial build can take a while, so disable the associated warning
#
# Unfortunately, this only works *after* the first run
#
export DIRENV_WARN_TIMEOUT=0

# Init the environment
#
use flake

# Python setup
#
#
# Inspired by:
#
#   https://github.com/direnv/direnv/issues/1194#issuecomment-1849002795
#
# Note that we need to call `layout python` once to set VIRTUAL_ENV,
# even though we may wipe-and-rebuild it later. The net result is that
# $VIRTUAL_ENV/bin will sometimes be present twice in the PATH.
#
layout python
watch_file requirements.txt

export PIP_NO_BINARY=":all:"

if [[ ! -f "$VIRTUAL_ENV"/.sentinal ]] && [[ -f requirements.lock ]]; then
    echo "direnv: Installing Python packages from requirements.lock"

    if [[ -d "$VIRTUAL_ENV" ]]; then
        rm -rf "$VIRTUAL_ENV"
        layout python
    fi

    pip install -r requirements.lock

    touch "$VIRTUAL_ENV"/.sentinal
elif [[ ! -f "$VIRTUAL_ENV"/.sentinal ]] || [[ requirements.txt -nt "$VIRTUAL_ENV"/.sentinal ]]; then
    echo "direnv: Installing Python packages from requirements.txt"

    if [[ -d "$VIRTUAL_ENV" ]]; then
        rm -rf "$VIRTUAL_ENV"
        layout python
    fi

    pip install --upgrade pip
    pip install -r requirements.txt

    pip freeze --all --local >requirements.lock
    touch "$VIRTUAL_ENV"/.sentinal
fi

if [[ ! -f "$VIRTUAL_ENV"/.solc-select/.keep ]]; then
    echo "direnv: Setting up solc-select cache"
    ln -sf "$PWD"/appdata/solc-select "$VIRTUAL_ENV"/.solc-select
fi

# It's not uncommon to proxy Python apps through Burp Suite or another
# tool, which can result in warnings about untrusted SSL certificates.
# These are annoying, so we disable them. (DON'T do this GLOBALLY
# though! Warnings about unverified SSL certificates exist for a
# reason!)
#
export PYTHONWARNINGS="${PYTHONWARNINGS:+$PYTHONWARNINGS,}ignore:Unverified HTTPS request"

# Node setup
#
layout node
watch_file package.json

if [[ ! -f node_modules/.sentinal ]] && [[ -f pnpm-lock.yaml ]]; then
    echo "direnv: Installing Node packages from pnpm-lock.yaml"

    if [[ -d node_modules ]]; then
        rm -rf node_modules
    fi

    pnpm install

    touch node_modules/.sentinal
elif [[ ! -f node_modules/.sentinal ]] || [[ package.json -nt pnpm-lock.yaml ]]; then
    echo "direnv: Installing Node packages from package.json"

    if [[ -d node_modules ]]; then
        rm -rf node_modules
    fi
    if [[ -f pnpm-lock.yaml ]]; then
        rm pnpm-lock.yaml
    fi

    pnpm install

    touch node_modules/.sentinal
fi

# Ruby setup
#
layout ruby
watch_file Gemfile

if [[ ! -f "$GEM_HOME"/.sentinal ]] && [[ -f Gemfile.lock ]]; then
    echo "direnv: Installing Ruby gems from Gemfile.lock"

    if [[ -d "$GEM_HOME" ]]; then
        rm -rf "$GEM_HOME"
        layout ruby
    fi
    find "$PWD"/.direnv/bin -type f -exec grep -l "This file was generated by Bundler" "{}" \; | while read -r BUNDLER_BIN; do
        rm -f "$BUNDLER_BIN"
    done

    bundle install 2>/dev/null

    touch "$GEM_HOME"/.sentinal
elif [[ ! -f "$GEM_HOME"/.sentinal ]] || [[ Gemfile -nt Gemfile.lock ]]; then
    echo "direnv: Installing Ruby gems from Gemfile"

    if [[ -d "$GEM_HOME" ]]; then
        rm -rf "$GEM_HOME"
        layout ruby
    fi
    if [[ -f Gemfile.lock ]]; then
        rm Gemfile.lock
    fi
    find "$PWD"/.direnv/bin -type f -exec grep -l "This file was generated by Bundler" "{}" \; | while read -r BUNDLER_BIN; do
        rm -f "$BUNDLER_BIN"
    done

    bundle install 2>/dev/null

    touch "$GEM_HOME"/.sentinal
fi

# Shodan configuration
#
export PYTHONWARNINGS="${PYTHONWARNINGS:+$PYTHONWARNINGS,}ignore:pkg_resources is deprecated"

# Goose configuration
#
export GOOSE_PATH_ROOT="$PWD"/appdata/goose
export CONTEXT_FILE_NAMES='["ENGAGEMENT.md", "AGENT.md", ".goosehints", "CLAUDE.md", ".cursorrules", "global_rules.md"]'
