#!/usr/bin/env bash

set -e

# Load libenv.sh
#
source "$(dirname "$(realpath "$0")")"/shlib/libenv.sh

# Determine Claude Code executable
#
CLAUDE_CODE_PATH="$(unmask_executable claude)"

# Resolve (potentially) critical paths in the environment, as nono will
# not follow home-manager's symlinks without making all of $HOME
# readable
#
SEP=""
NEW_PATH=""
while IFS=: read -d: -r DIR; do
    if [[ -d "$DIR" ]]; then
        NEW_PATH="$NEW_PATH$SEP$(realpath "$DIR")"
        if [[ -z "$SEP" ]]; then
            SEP=":"
        fi
    fi
done <<<"${PATH:+"${PATH}:"}"

SEP=""
NEW_MANPATH=""
while IFS=: read -d: -r DIR; do
    if [[ -d "$DIR" ]]; then
        NEW_MANPATH="$NEW_MANPATH$SEP$(realpath "$DIR")"
        if [[ -z "$SEP" ]]; then
            SEP=":"
        fi
    fi
done <<<"${MANPATH:+"${MANPATH}:"}"

SEP=""
NEW_XDG_CONFIG_DIRS=""
while IFS=: read -d: -r DIR; do
    if [[ -d "$DIR" ]]; then
        NEW_XDG_CONFIG_DIRS="$NEW_XDG_CONFIG_DIRS$SEP$(realpath "$DIR")"
        if [[ -z "$SEP" ]]; then
            SEP=":"
        fi
    fi
done <<<"${XDG_CONFIG_DIRS:+"${XDG_CONFIG_DIRS}:"}"

SEP=""
NEW_XDG_DATA_DIRS=""
while IFS=: read -d: -r DIR; do
    if [[ -d "$DIR" ]]; then
        NEW_XDG_DATA_DIRS="$NEW_XDG_DATA_DIRS$SEP$(realpath "$DIR")"
        if [[ -z "$SEP" ]]; then
            SEP=":"
        fi
    fi
done <<<"${XDG_DATA_DIRS:+"${XDG_DATA_DIRS}:"}"

# Set defaults for XDG variables
#
if [[ -z "$XDG_CACHE_HOME" ]]; then
    export XDG_CACHE_HOME="$HOME"/.cache
fi
if [[ -z "$XDG_CONFIG_HOME" ]]; then
    export XDG_CONFIG_HOME="$HOME"/.config
fi
if [[ -z "$XDG_DATA_HOME" ]]; then
    export XDG_DATA_HOME="$HOME"/.local/share
fi
if [[ -z "$XDG_STATE_HOME" ]]; then
    export XDG_STATE_HOME="$HOME"/.local/state
fi

# Launch Claude Code (but only if not called recursively to avoid
# sandboxing the sandbox)
#
if [[ -n "$CLAUDE_CODE_PATH" ]]; then
    if [[ -z "$CLAUDECODE" ]]; then
        # Note that all of the allow/allow-file/read/read-fil lines
        # (except for `--allow .`) can be replaced by a custom profile
        # once nono v0.6.0 hits nixpkgs-unstable
        #
        # shellcheck disable=SC2046
        exec env -S \
            $([[ -z "$NEW_PATH" ]] && echo -n "-u PATH") \
            $([[ -z "$NEW_MANPATH" ]] && echo -n "-u MANPATH") \
            $([[ -z "$NEW_XDG_CONFIG_DIRS" ]] && echo -n "-u XDG_CONFIG_DIRS") \
            $([[ -z "$NEW_XDG_DATA_DIRS" ]] && echo -n "-u XDG_DATA_DIRS") \
            $([[ -n "$NEW_PATH" ]] && echo -n "PATH=\"$NEW_PATH\"") \
            $([[ -n "$NEW_MANPATH" ]] && echo -n "MANPATH=\"$NEW_MANPATH\"") \
            $([[ -n "$NEW_XDG_CONFIG_DIRS" ]] && echo -n "XDG_CONFIG_DIRS=\"$NEW_XDG_CONFIG_DIRS\"") \
            $([[ -n "$NEW_XDG_DATA_DIRS" ]] && echo -n "XDG_DATA_DIRS=\"$NEW_XDG_DATA_DIRS\"") \
            CLAUDE_CODE_SHELL="$(realpath $(which bash))" \
            "$(realpath "$(which nono)")" run \
            --profile claude-code \
            --allow "$(get_direnv_path "$(dirname "$(realpath "$0")")")" \
            $([[ -d "$XDG_CACHE_HOME"/fish ]] && echo -n "--allow $XDG_CACHE_HOME/fish") \
            $([[ -d "$XDG_CACHE_HOME"/go-build ]] && echo -n "--allow $XDG_CACHE_HOME/go-build") \
            $([[ -d "$XDG_CACHE_HOME"/pip ]] && echo -n "--allow $XDG_CACHE_HOME/pip") \
            $([[ -d "$XDG_CACHE_HOME"/pnpm ]] && echo -n "--allow $XDG_CACHE_HOME/pnpm") \
            $([[ -d "$XDG_CACHE_HOME"/uv ]] && echo -n "--allow $XDG_CACHE_HOME/uv") \
            $([[ -d "$XDG_CONFIG_HOME"/fish ]] && echo -n "--allow $XDG_CONFIG_HOME/fish") \
            $([[ -d "$XDG_CONFIG_HOME"/go ]] && echo -n "--allow $XDG_CONFIG_HOME/go") \
            $([[ -d "$XDG_DATA_HOME"/delta ]] && echo -n "--allow $XDG_DATA_HOME/delta") \
            $([[ -d "$XDG_DATA_HOME"/fish ]] && echo -n "--allow $XDG_DATA_HOME/fish") \
            $([[ -d "$XDG_DATA_HOME"/pnpm ]] && echo -n "--allow $XDG_DATA_HOME/pnpm") \
            $([[ -d "$XDG_STATE_HOME"/pnpm ]] && echo -n "--allow $XDG_STATE_HOME/pnpm") \
            $([[ -d /tmp ]] && echo -n "--allow /tmp") \
            $([[ -e /dev/null ]] && echo -n "--allow-file /dev/null") \
            $([[ -d "$HOME"/.ssh ]] && echo -n "--read $HOME/.ssh") \
            $([[ -d "$XDG_CACHE_HOME"/bat ]] && echo -n "--read $XDG_CACHE_HOME/bat") \
            $([[ -d "$XDG_CONFIG_HOME" ]] && echo -n "--read $XDG_CONFIG_HOME") \
            $([[ -d /etc/skel ]] && echo -n "--read /etc/skel") \
            $([[ -d /nix ]] && echo -n "--read /nix") \
            $([[ -d /usr/share ]] && echo -n "--read /usr/share") \
            $([[ -e "$HOME"/.bash_aliases ]] && echo -n "--read-file $HOME/.bash_aliases") \
            $([[ -e /etc/bashrc ]] && echo -n "--read-file /etc/bashrc") \
            -- "$CLAUDE_CODE_PATH" --dangerously-skip-permissions "$@"
    else
        exec "$CLAUDE_CODE_PATH" "$@"
    fi
else
    echo "Real Claude Code executable not found!"
    exit 1
fi
